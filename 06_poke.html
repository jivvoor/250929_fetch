<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>포켓몬 도감</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css');

        @font-face {
            font-family: 'Galmuri11';
            src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/2506-1@1.0/Galmuri11-Bold.woff2') format('woff2');
            font-weight: 700;
            font-display: swap;
        }
        body {
            font-family: "Galmuri11", serif;
        }
        .bg-white {
            background-color: rgb(225 198 62);
        }
        #searchBtn {
            background-color: rgb(247, 217, 67);
        }
        #searchBtn:hover {
            background-color: rgb(227, 197, 47);
        }
    </style>
  </head>
  <body class="bg-gray-100">
    <div
      class="container mx-auto mt-10 p-4 max-w-6xl bg-white rounded-lg shadow-lg"
    >
      <h1 class="text-3xl font-bold text-center mb-6">포켓몬 도감</h1>

      <section class="flex items-center justify-center mb-4">
        <label for="pokeId" class="mr-2 font-bold">포켓몬 ID :</label>
        <input
          id="pokeId"
          type="number"
          min="1"
          class="border-2 border-gray-300 p-2 rounded-md w-24 text-center"
        />
        <button
          id="searchBtn"
          class="ml-2 text-white font-bold py-2 px-4 rounded"
        >
          검색
        </button>
        <button
          id="backBtn"
          class="ml-2 bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded hidden"
        >
          돌아가기
        </button>
      </section>

      <nav id="paginationNav" class="flex justify-center items-center space-x-4 mb-6">
        <button
          id="prevBtn"
          class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:bg-gray-400"
        >
          이전
        </button>
        <button
          id="nextBtn"
          class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded disabled:bg-gray-400"
        >
          다음
        </button>
      </nav>

      <div id="loading" class="text-center text-xl font-semibold">로딩 중...</div>

      <section id="pokeBox"
        class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-4"
      ></section>
    </div>

    <div class="container mx-auto mt-10 p-4 max-w-6xl bg-white rounded-lg shadow-lg">
        <h2 class="text-2xl font-bold text-center mb-4">나의 포켓몬</h2>
        <section id="myPokeBox" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-4"></section>
    </div>

    <script>
      const pokeBox = document.getElementById("pokeBox");
      const myPokeBox = document.getElementById("myPokeBox");
      const loading = document.getElementById("loading");
      const paginationNav = document.getElementById("paginationNav");
      const nextBtn = document.getElementById("nextBtn");
      const prevBtn = document.getElementById("prevBtn");
      const searchBtn = document.getElementById("searchBtn");
      const pokeIdInput = document.getElementById("pokeId");
      const backBtn = document.getElementById("backBtn");

      const initialUrl = "https://pokeapi.co/api/v2/pokemon?limit=21";
      let nextUrl = null;
      let prevUrl = null;
      let currentPageUrl = initialUrl;
      let myPokemonList = [];

      // --- Main List View Functions ---
      async function fetchAndRenderPokemon(url) {
        currentPageUrl = url;
        showLoading(true);
        showPagination(true);

        try {
          const response = await fetch(url);
          const data = await response.json();

          nextUrl = data.next;
          prevUrl = data.previous;

          const pokemonPromises = data.results.map(async (pokemon) => {
            const detailResponse = await fetch(pokemon.url);
            const detailData = await detailResponse.json();
            const koNameObj = (await (await fetch(`https://pokeapi.co/api/v2/pokemon-species/${detailData.id}`)).json()).names.find(v => v.language.name === 'ko');
            return {
              id: detailData.id,
              name: koNameObj ? koNameObj.name : detailData.name,
              shape: detailData.sprites.front_default,
            };
          });

          const pokemonList = await Promise.all(pokemonPromises);
          renderPokemonList(pokemonList);
        } catch (error) {
          handleError("리스트를 불러오는 데 실패했습니다.");
        } finally {
          showLoading(false);
          nextBtn.disabled = !nextUrl;
          prevBtn.disabled = !prevUrl;
        }
      }

      function renderPokemonList(pokemonList) {
        pokeBox.className = "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-4";
        pokeBox.innerHTML = pokemonList
          .map(
            (p) => `
            <div class="p-4 border rounded-lg bg-gray-50 text-center shadow hover:shadow-md transition-shadow">
                <div class="cursor-pointer" onclick='searchAndShowPokemon(${p.id})'>
                    <img src="${p.shape}" alt="${p.name}" class="mx-auto h-24 w-24">
                    <h5 class="text-sm text-gray-500 mt-2">#${p.id}</h5>
                    <h4 class="text-md font-semibold capitalize">${p.name}</h4>
                </div>
                <button onclick='addPokemon(${JSON.stringify(p)})' class="mt-2">잡아랏!
                    <img src="R.png" alt="Add to my pokemon" class="mx-auto h-8 w-8">
                </button>
            </div>
        `
          )
          .join("");
      }

      function addPokemon(pokemon) {
        if (myPokemonList.find(p => p.id === pokemon.id)) {
            alert("이미 추가된 포켓몬입니다.");
            return;
        }
        myPokemonList.push(pokemon);
        renderMyPokemon();
      }

      function renderMyPokemon() {
        myPokeBox.innerHTML = myPokemonList.map(p => `
            <div class="p-4 border rounded-lg bg-gray-50 text-center shadow">
                <img src="${p.shape}" alt="${p.name}" class="mx-auto h-24 w-24">
                <h5 class="text-sm text-gray-500 mt-2">#${p.id}</h5>
                <h4 class="text-md font-semibold capitalize">${p.name}</h4>
            </div>
        `).join("");
      }

      // --- Single Pokemon (Search) View Functions ---
      async function searchAndShowPokemon(id) {
        if (!id) {
          alert("포켓몬 ID를 입력해주세요.");
          return;
        }
        showLoading(true);
        showPagination(false);

        try {
          const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
          const data = await response.json();

          const response2 = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`);
          const data2 = await response2.json();

          const koNameObj = data2.names.find((v) => v.language.name === "ko");
          const koName = koNameObj ? koNameObj.name : data.name;

          const koFlavorTextObj = data2.flavor_text_entries.find(entry => entry.language.name === 'ko');
          const flavorText = koFlavorTextObj ? koFlavorTextObj.flavor_text : '설명 없음';

          const typesPromises = data.types.map(async (typeInfo) => {
            const typeRes = await fetch(typeInfo.type.url);
            const typeData = await typeRes.json();
            const koType = typeData.names.find(name => name.language.name === 'ko');
            return koType ? koType.name : typeInfo.type.name;
          });
          const types = await Promise.all(typesPromises);

          const abilitiesPromises = data.abilities.map(async (abilityInfo) => {
            const abilityRes = await fetch(abilityInfo.ability.url);
            const abilityData = await abilityRes.json();
            const koAbility = abilityData.names.find(name => name.language.name === 'ko');
            return koAbility ? koAbility.name : abilityInfo.ability.name;
          });
          const abilities = await Promise.all(abilitiesPromises);

          const statsPromises = data.stats.map(async (statInfo) => {
            const statRes = await fetch(statInfo.stat.url);
            const statData = await statRes.json();
            const koStat = statData.names.find(name => name.language.name === 'ko');
            return {
                name: koStat ? koStat.name : statInfo.stat.name,
                base_stat: statInfo.base_stat
            };
          });
          const stats = await Promise.all(statsPromises);

          const pokeData = {
            id: data.id,
            engName: data.name,
            koName,
            shape: data.sprites.front_default,
            sound: data.cries.latest,
            flavorText,
            types,
            abilities,
            stats,
            height: data.height / 10, // m 단위로 변환
            weight: data.weight / 10, // kg 단위로 변환
          };

          renderSinglePokemon(pokeData);
        } catch (error) {
            handleError(`ID ${id}에 해당하는 포켓몬을 찾을 수 없습니다.`);
        } finally {
            showLoading(false);
        }
      }

      function renderSinglePokemon(pokemon) {
        const pokemonToAdd = {
            id: pokemon.id,
            name: pokemon.koName,
            shape: pokemon.shape
        };
        pokeBox.className = "flex justify-center";
        pokeBox.innerHTML = `
            <div class="p-6 border rounded-lg bg-gray-50 shadow-xl w-full max-w-2xl">
                <div class="text-center">
                    <h5 class="text-lg text-gray-500">#${pokemon.id}</h5>
                    <h4 class="text-3xl font-bold">${pokemon.koName}</h4>
                    <h5 class="text-xl text-gray-500 mb-4 capitalize">${pokemon.engName}</h5>
                    <img src="${pokemon.shape}" alt="${pokemon.koName}" class="mx-auto h-48 w-48">
                    <audio src="${pokemon.sound}" controls class="mt-4 mx-auto w-full max-w-xs"></audio>
                </div>
                <div class="mt-4 text-center">
                    <p class="italic">"${pokemon.flavorText}"</p>
                </div>
                <div class="mt-4 grid grid-cols-2 gap-4 text-center">
                    <div><strong>타입:</strong> ${pokemon.types.join(', ')}</div>
                    <div><strong>특성:</strong> ${pokemon.abilities.join(', ')}</div>
                    <div><strong>키:</strong> ${pokemon.height} m</div>
                    <div><strong>몸무게:</strong> ${pokemon.weight} kg</div>
                </div>
                <div class="mt-4">
                    <h5 class="font-bold text-center mb-2">능력치</h5>
                    ${pokemon.stats.map(stat => `
                        <div class="flex justify-between items-center">
                            <span class="w-1/3 text-sm">${stat.name}</span>
                            <div class="w-2/3 bg-gray-200 rounded-full h-4"><div class="bg-blue-500 h-4 rounded-full text-xs text-white text-center leading-4" style="width: ${Math.min(stat.base_stat, 150) / 1.5}%">${stat.base_stat}</div></div>
                        </div>
                    `).join('')}
                </div>
                <div class="text-center mt-4"><button onclick='addPokemon(${JSON.stringify(pokemonToAdd)})' class="mt-2"><img src="R.png" alt="Add to my pokemon" class="mx-auto h-8 w-8"></button></div>
            </div>
        `;
      }

      // --- UI Control & Event Handlers ---
      function showLoading(isLoading) {
        loading.style.display = isLoading ? "block" : "none";
        if (isLoading) pokeBox.innerHTML = "";
      }

      function showPagination(isShown) {
          paginationNav.style.display = isShown ? "flex" : "none";
          backBtn.style.display = isShown ? "none" : "block";
      }
      
      function handleError(message) {
          console.error(message);
          pokeBox.innerHTML = `<p class="text-red-500 text-center col-span-full">${message}</p>`;
      }

      nextBtn.addEventListener("click", () => nextUrl && fetchAndRenderPokemon(nextUrl));
      prevBtn.addEventListener("click", () => prevUrl && fetchAndRenderPokemon(prevUrl));
      searchBtn.addEventListener("click", () => searchAndShowPokemon(pokeIdInput.value));
      pokeIdInput.addEventListener("keypress", (e) => e.key === 'Enter' && searchAndShowPokemon(pokeIdInput.value));
      backBtn.addEventListener("click", () => fetchAndRenderPokemon(currentPageUrl));

      // --- Initial Load ---
      document.addEventListener("DOMContentLoaded", () => fetchAndRenderPokemon(initialUrl));
    </script>
  </body>
</html>